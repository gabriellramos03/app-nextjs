name: Notify on PR merge

on:
  pull_request:
    types:
      - closed
    branches:
      - main
      - kaik_test

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Send notification to Telegram
        if: github.event.pull_request.merged == true
        run: |
          export TZ="America/La_Paz"
          PR_MERGE_TIME=$(date -d "${{ github.event.pull_request.merged_at }}" +"%Y-%m-%d %H:%M:%S")

          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          echo "Autor da PR: $PR_AUTHOR"

          HTTP_STATUS=$(curl -s -o approvals.json -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews")

          echo "HTTP Status da requisi√ß√£o: $HTTP_STATUS"
          echo "Resposta da API: $(cat approvals.json)"

          if [ "$HTTP_STATUS" -ne 200 ]; then
            echo "Erro ao chamar a API do GitHub. Status: $HTTP_STATUS"
            APPROVED_BY="Erro ao consultar a API"
          else
            APPROVALS=$(cat approvals.json)
            echo "Revis√µes encontradas: $APPROVALS"

            echo "Estados das revis√µes: $(echo "$APPROVALS" | jq -r '[.[] | {state: .state, user: .user.login}]')"

            APPROVED_BY=$(echo "$APPROVALS" | jq -r '[.[] | select(.state == "APPROVED") | .user.login] | join(", @")' || echo "Erro no jq")
            echo "Aprovadores antes da condi√ß√£o: '$APPROVED_BY'"

            if [ -z "$APPROVED_BY" ] || [ "$APPROVED_BY" == "null" ] || [ "$APPROVED_BY" == "Erro no jq" ]; then
              APPROVALS_COUNT=$(echo "$APPROVALS" | jq -r 'length')
              if [ "$APPROVALS_COUNT" -eq 0 ]; then
                APPROVED_BY="Nenhuma revis√£o encontrada"
              else
                APPROVED_BY="Nenhuma aprova√ß√£o encontrada"
              fi
            else
              APPROVED_BY="@${APPROVED_BY}"
            fi
          fi

          echo "Aprovadores finais: $APPROVED_BY"

          curl -s -X POST "https://api.telegram.org/bot7363146072:AAGI8pvEpgIbWzyAiV1BWb6v50NIRVirS9Q/sendMessage" \
            -d "chat_id=2130096655" \
            -d "text=Merge realizado no projeto *${{ github.repository }}*! %0A\
            üïí Hor√°rio do merge: *$PR_MERGE_TIME* %0A\
            üë§ Autor: *@$PR_AUTHOR* %0A\
            ‚úÖ Aprovado por: $APPROVED_BY"